<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Case Studies in Data Mining with R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Yi-Ju Tseng" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Case Studies in Data Mining with R
### Yi-Ju Tseng
### Chung Gung University
### 2020/05/18

---

class: inverse, center, middle
# Reviews
---

## R and RStudio

[R](https://cloud.r-project.org/) : Core (engine)

&lt;img src="https://www.teslarati.com/wp-content/uploads/2018/07/model-3-drivetrain-1.jpg" height="400px" style="display: block; margin: auto;" /&gt;

[Source](https://www.teslarati.com/tesla-patent-more-efficient-electric-motors/)

---
## R and RStudio

[RStudio](https://www.rstudio.com/products/rstudio/download/#download) : IDE (dashboard)

&lt;img src="https://raw.githubusercontent.com/DHLab-TSENG/emr_slide/master/emr_package-figure/dashboard.jpg" height="400px" style="display: block; margin: auto;" /&gt;

[Source](https://www.theverge.com/2015/3/19/8260295/tesla-user-interface-redesign-concept)

---

## How to use RStudio for the first time
.pull-left[
4 Blocks in RStudio：
- Source editor  -&gt; edit the codes here
- Console -&gt; get the results here
]
.pull-right[
&lt;/br&gt;
- Environment/...
- File/Figure/...
]

&lt;img src="https://raw.githubusercontent.com/DHLab-TSENG/emr_slide/master/emr_package-figure/RStudio.png" height="350px" style="display: block; margin: auto;" /&gt;

---
## R and R Packages

R : Core (iPhone)

&lt;img src="https://store.storeimages.cdn-apple.com/4982/as-images.apple.com/is/iphone-xr-white-select-201809?wid=940&amp;hei=1112&amp;fmt=png-alpha&amp;qlt=80&amp;.v=1551226036668" height="400px" style="display: block; margin: auto;" /&gt;

---
## R and R Packages

R Packages : APP

&lt;img src="https://3c.yipee.cc/wp-content/uploads/2019/06/a7ffbaa3df50d7cafe6801a8a8d7a3bf-620x320.jpg" height="400px" style="display: block; margin: auto;" /&gt;

[Source](https://www.apple.com/)

---
## Install and Use Packages

- Install


```r
*install.packages("tidymodels")
library(tidymodels)
```

--


- Use


```r
install.packages("tidymodels")  
*library(tidymodels)
```

```
## Registered S3 method overwritten by 'xts':
##   method     from
##   as.zoo.xts zoo
```

```
## ── Attaching packages ───────────────────────────────────── tidymodels 0.1.0 ──
```

```
## ✓ broom     0.5.6      ✓ recipes   0.1.12
## ✓ dials     0.0.6      ✓ rsample   0.0.6 
## ✓ dplyr     0.8.5      ✓ tibble    3.0.1 
## ✓ ggplot2   3.2.1      ✓ tune      0.1.0 
## ✓ infer     0.5.1      ✓ workflows 0.1.1 
## ✓ parsnip   0.1.1      ✓ yardstick 0.0.6 
## ✓ purrr     0.3.3
```

```
## Warning: package 'broom' was built under R version 3.6.2
```

```
## Warning: package 'dials' was built under R version 3.6.2
```

```
## Warning: package 'scales' was built under R version 3.6.2
```

```
## Warning: package 'parsnip' was built under R version 3.6.2
```

```
## Warning: package 'recipes' was built under R version 3.6.2
```

```
## Warning: package 'rsample' was built under R version 3.6.2
```

```
## Warning: package 'tibble' was built under R version 3.6.2
```

```
## Warning: package 'tune' was built under R version 3.6.2
```

```
## ── Conflicts ──────────────────────────────────────── tidymodels_conflicts() ──
## x purrr::discard()  masks scales::discard()
## x dplyr::filter()   masks stats::filter()
## x dplyr::lag()      masks stats::lag()
## x ggplot2::margin() masks dials::margin()
## x recipes::step()   masks stats::step()
```

---
## Pipe %&gt;%

---

class: inverse, center, middle

# Get Started - Data Import

---

## 建模範例資料 - 載入

- `mlbench`套件內附的`PimaIndiansDiabetes2`資料集
- Outcome為是否有糖尿病  **diabetes**欄位
- 可輸入`?PimaIndiansDiabetes2`查看所有欄位變數


```r
library(mlbench)
data("PimaIndiansDiabetes2") # 載入資料
```
---

## 建模範例資料 - 初探

- 用`glimpse()`函數看一下各資料的**型態**跟資料**筆數**

```r
glimpse(PimaIndiansDiabetes2)
```

```
## Rows: 768
## Columns: 9
## $ pregnant &lt;dbl&gt; 6, 1, 8, 1, 0, 5, 3, 10, 2, 8, 4, 10, 10, 1, 5, 7, 0, 7, 1, …
## $ glucose  &lt;dbl&gt; 148, 85, 183, 89, 137, 116, 78, 115, 197, 125, 110, 168, 139…
## $ pressure &lt;dbl&gt; 72, 66, 64, 66, 40, 74, 50, NA, 70, 96, 92, 74, 80, 60, 72, …
## $ triceps  &lt;dbl&gt; 35, 29, NA, 23, 35, NA, 32, NA, 45, NA, NA, NA, NA, 23, 19, …
## $ insulin  &lt;dbl&gt; NA, NA, NA, 94, 168, NA, 88, NA, 543, NA, NA, NA, NA, 846, 1…
## $ mass     &lt;dbl&gt; 33.6, 26.6, 23.3, 28.1, 43.1, 25.6, 31.0, 35.3, 30.5, NA, 37…
## $ pedigree &lt;dbl&gt; 0.627, 0.351, 0.672, 0.167, 2.288, 0.201, 0.248, 0.134, 0.15…
## $ age      &lt;dbl&gt; 50, 31, 32, 21, 33, 30, 26, 29, 53, 54, 30, 34, 57, 59, 51, …
## $ diabetes &lt;fct&gt; pos, neg, pos, neg, pos, neg, pos, neg, pos, pos, neg, pos, …
```
- 發現有不少空值，要決定如何處理

---

## 建模範例資料 - Outcome比例

- 在處理空值前，先看**diabetes**欄位中有病跟沒病的人數與比例


```r
PimaIndiansDiabetes2 %&gt;% 
  count(diabetes) %&gt;% 
  mutate(prop = n/sum(n))
```

```
## # A tibble: 2 x 3
##   diabetes     n  prop
##   &lt;fct&gt;    &lt;int&gt; &lt;dbl&gt;
## 1 neg        500 0.651
## 2 pos        268 0.349
```

- 大概是65:35，有些不平均，但還行

---
## 刪除空（遺漏）值

- 臨床研究通常會刪除有**缺值**的資料
- 為了後續敘述性統計方便，若狀況許可，會在第一步刪除資料
- 某些演算法不能用有空值的資料建模



```r
PimaIndiansDiabetes2&lt;-
* PimaIndiansDiabetes2 %&gt;%
  filter(complete.cases(PimaIndiansDiabetes2)) 
```


---
## 刪除遺漏值

- 臨床研究通常會刪除有**缺值**的資料
- 為了後續敘述性統計方便，若狀況許可，會在第一步刪除資料
- 某些演算法不能用有空值的資料建模



```r
PimaIndiansDiabetes2&lt;-
  PimaIndiansDiabetes2 %&gt;% 
* filter(complete.cases(PimaIndiansDiabetes2))
```

- `filter()`為`dplyr`套件的功能，可針對資料列(row)做子集

--

.pull-left[

 ID  Name 
---  -----
  1  a    
  2  b    
  3  c    
]
--
.pull-right[

 ID  Name 
---  -----
  1  a    
  3  c    
]

---
## 刪除遺漏值

- 臨床研究通常會刪除有缺值的資料
- 為了後續敘述性統計方便，若狀況許可，會在第一步刪除資料
- 某些演算法不能用有空值的資料建模



```r
PimaIndiansDiabetes2&lt;-
  PimaIndiansDiabetes2 %&gt;% 
* filter(complete.cases(PimaIndiansDiabetes2))
```

- `filter()`為`dplyr`套件的功能，可針對資料列(row)做子集
- 用`complete.cases()`辨識是否為完整資料，若沒有空值，回傳TRUE

---
## 刪除遺漏值後 - Outcome比例

刪除空後資料筆數有些微改變，但大概還是6x:3x的比例


```r
PimaIndiansDiabetes2 %&gt;% 
  count(diabetes) %&gt;% 
  mutate(prop = n/sum(n))
```

```
## # A tibble: 2 x 3
##   diabetes     n  prop
##   &lt;fct&gt;    &lt;int&gt; &lt;dbl&gt;
## 1 neg        262 0.668
## 2 pos        130 0.332
```

---
class: inverse, center, middle

# 敘述性統計

---
## 醫學資料分析中的敘述性統計
- 通常是論文中的必要表格
- 描述有病沒病的兩群人的基本資料，並做**統計檢定**
&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneExample.png" height="400px" style="display: block; margin: auto;" /&gt;
[Source](https://www.sciencedirect.com/science/article/abs/pii/S1386505618311213)

---
## 單變量分析
- 使用`tableone`套件完成表格，第一次使用前要先安裝
- 將去除空值的資料`PimaIndiansDiabetes2`放入`CreateTableOne()`函數

```r
library(tableone)
tableone&lt;-
* CreateTableOne(data=PimaIndiansDiabetes2)
print(tableone)
```

```
##                       
##                        Overall        
##   n                       392         
##   pregnant (mean (SD))   3.30 (3.21)  
##   glucose (mean (SD))  122.63 (30.86) 
##   pressure (mean (SD))  70.66 (12.50) 
##   triceps (mean (SD))   29.15 (10.52) 
##   insulin (mean (SD))  156.06 (118.84)
##   mass (mean (SD))      33.09 (7.03)  
##   pedigree (mean (SD))   0.52 (0.35)  
##   age (mean (SD))       30.86 (10.20) 
##   diabetes = pos (%)      130 (33.2)
```
- [tableone使用說明](https://cran.r-project.org/web/packages/tableone/vignettes/introduction.html)
---
## 單變量分析 - 依outcome分組


```r
library(tableone)
tableone&lt;-
  CreateTableOne(data=PimaIndiansDiabetes2,
*                strata = "diabetes")
print(tableone)
```

```
##                       Stratified by diabetes
##                        neg             pos             p      test
##   n                       262             130                     
##   pregnant (mean (SD))   2.72 (2.62)     4.47 (3.92)   &lt;0.001     
##   glucose (mean (SD))  111.43 (24.64)  145.19 (29.84)  &lt;0.001     
##   pressure (mean (SD))  68.97 (11.89)   74.08 (13.02)  &lt;0.001     
##   triceps (mean (SD))   27.25 (10.43)   32.96 (9.64)   &lt;0.001     
##   insulin (mean (SD))  130.85 (102.63) 206.85 (132.70) &lt;0.001     
##   mass (mean (SD))      31.75 (6.79)    35.78 (6.73)   &lt;0.001     
##   pedigree (mean (SD))   0.47 (0.30)     0.63 (0.41)   &lt;0.001     
##   age (mean (SD))       28.35 (8.99)    35.94 (10.63)  &lt;0.001     
##   diabetes = pos (%)        0 (0.0)       130 (100.0)  &lt;0.001
```

---
## 單變量分析 - 產生方便貼到Excel的表格


```r
library(tableone)
tableone&lt;-
  CreateTableOne(data=PimaIndiansDiabetes2,
                 strata = "diabetes")
*print(tableone,quote = T)
```

```
##                         "Stratified by diabetes"
##  ""                      "neg"             "pos"             "p"      "test"
##   "n"                    "   262"          "   130"          ""       ""    
##   "pregnant (mean (SD))" "  2.72 (2.62)"   "  4.47 (3.92)"   "&lt;0.001" ""    
##   "glucose (mean (SD))"  "111.43 (24.64)"  "145.19 (29.84)"  "&lt;0.001" ""    
##   "pressure (mean (SD))" " 68.97 (11.89)"  " 74.08 (13.02)"  "&lt;0.001" ""    
##   "triceps (mean (SD))"  " 27.25 (10.43)"  " 32.96 (9.64)"   "&lt;0.001" ""    
##   "insulin (mean (SD))"  "130.85 (102.63)" "206.85 (132.70)" "&lt;0.001" ""    
##   "mass (mean (SD))"     " 31.75 (6.79)"   " 35.78 (6.73)"   "&lt;0.001" ""    
##   "pedigree (mean (SD))" "  0.47 (0.30)"   "  0.63 (0.41)"   "&lt;0.001" ""    
##   "age (mean (SD))"      " 28.35 (8.99)"   " 35.94 (10.63)"  "&lt;0.001" ""    
##   "diabetes = pos (%)"   "     0 (0.0) "   "   130 (100.0) " "&lt;0.001" ""
```

---
## 單變量分析 - Excel處理步驟 (1/7)

調整Console視窗大小，讓結果不被強迫換行

&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneR.png" height="400px" style="display: block; margin: auto;" /&gt;

---
## 單變量分析 - Excel處理步驟 (2/7)

全選表格

&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneRSelect.png" height="400px" style="display: block; margin: auto;" /&gt;

---
## 單變量分析 - Excel處理步驟 (3/7)

打開Excel貼上
&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneRExcel.png" height="400px" style="display: block; margin: auto;" /&gt;
---
## 單變量分析 - Excel處理步驟 (4/7)
打開Excel-&gt;資料-&gt;資料剖析功能
&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneRExcelFormat.png" height="400px" style="display: block; margin: auto;" /&gt;
---
## 單變量分析 - Excel處理步驟 (5/7)
設定使用分隔符號切割資料
&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneRExcelDel.png" height="400px" style="display: block; margin: auto;" /&gt;
---
## 單變量分析 - Excel處理步驟 (6/7)
用空格當作分隔符號，並將文字辨識符號設為雙引號
&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneRExcelDelSetting.png" height="400px" style="display: block; margin: auto;" /&gt;


---
## 單變量分析 - Excel處理步驟 (7/7)
完成！！
&lt;img src="https://raw.githubusercontent.com/yijutseng/RCourses/master/figures/tableoneFinal.png" height="400px" style="display: block; margin: auto;" /&gt;
---
class: inverse, center, middle

# 開始建模 - 策略說明與資料分割

---

## 訓練/調整與驗證模型效能策略
How to Read Articles That Use Machine Learning - Users’ Guides to the Medical Literature [JAMA](https://jamanetwork.com/journals/jama/fullarticle/2754798)，說明在機器學習時代如何建立預測模型，跟傳統的不同
&lt;img src="https://cdn.jamanetwork.com/ama/content_public/journal/jama/938259/jug190001f2.png?Expires=2147483647&amp;Signature=cU6lP2ZYSdn9MyOakMWobXQF2h6LSPCExTP1q7x74zRH7gDgkRSqshXWADmcQUz0XJVK~aVPK3cb-~shWQ6vd6EF4FwIcR8NBXMlGq1sLDR5dXLwpb~qoEYzXvg03zCz2l0AHmdlFxy4IGYGG3ilBfuPh1SCweskxtaUfsWqGsUcwc6FNo3KjaR9j58eJeZOnBEr6a2OF2m~XlEOnT1W3vaYn2-fuGZLAQR88XcUGWp1LYgc6GnDTO1s7zj5m9mYhlL-CeOaLXQNGrSl6fAvw6LisZW-f2tChvIaDfCd4vuuNw-Q1V6sjm-jgUehMt8wjrc61YW6WqyIC9mF6VGzzg__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA" height="400px" style="display: block; margin: auto;" /&gt;
---

## 調整參數的必要性

- 在傳統"非"機器學習模型(圖上半部)，分訓練組與測試組
- 訓練模型時，記得不可以用**測試組**資料來訓練模型，才能得到真實的預測結果 (完全沒偷看答案的意思)
&lt;img src="https://cdn.jamanetwork.com/ama/content_public/journal/jama/938259/jug190001f2.png?Expires=2147483647&amp;Signature=cU6lP2ZYSdn9MyOakMWobXQF2h6LSPCExTP1q7x74zRH7gDgkRSqshXWADmcQUz0XJVK~aVPK3cb-~shWQ6vd6EF4FwIcR8NBXMlGq1sLDR5dXLwpb~qoEYzXvg03zCz2l0AHmdlFxy4IGYGG3ilBfuPh1SCweskxtaUfsWqGsUcwc6FNo3KjaR9j58eJeZOnBEr6a2OF2m~XlEOnT1W3vaYn2-fuGZLAQR88XcUGWp1LYgc6GnDTO1s7zj5m9mYhlL-CeOaLXQNGrSl6fAvw6LisZW-f2tChvIaDfCd4vuuNw-Q1V6sjm-jgUehMt8wjrc61YW6WqyIC9mF6VGzzg__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA" height="400px" style="display: block; margin: auto;" /&gt;

---

## 調整參數的必要性
- 在圖下半，主要差異是在訓練模型時多了一組**參數調整資料集**
- 因為在多種機器學習模型中，有可調整的參數
- 為了讓參數調整效果更好，會將訓練組再切分成小組，用來決定**最佳參數**
- 決定**最佳參數**以後，用**訓練組**搭配最佳參數訓練模型，最後用**測試組**測試
&lt;img src="https://cdn.jamanetwork.com/ama/content_public/journal/jama/938259/jug190001f2.png?Expires=2147483647&amp;Signature=cU6lP2ZYSdn9MyOakMWobXQF2h6LSPCExTP1q7x74zRH7gDgkRSqshXWADmcQUz0XJVK~aVPK3cb-~shWQ6vd6EF4FwIcR8NBXMlGq1sLDR5dXLwpb~qoEYzXvg03zCz2l0AHmdlFxy4IGYGG3ilBfuPh1SCweskxtaUfsWqGsUcwc6FNo3KjaR9j58eJeZOnBEr6a2OF2m~XlEOnT1W3vaYn2-fuGZLAQR88XcUGWp1LYgc6GnDTO1s7zj5m9mYhlL-CeOaLXQNGrSl6fAvw6LisZW-f2tChvIaDfCd4vuuNw-Q1V6sjm-jgUehMt8wjrc61YW6WqyIC9mF6VGzzg__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA" height="400px" style="display: block; margin: auto;" /&gt;
---

## 調整參數的必要性

本課程範例 :

- **邏輯迴歸Logistic Regression**示範此圖上半部**不調參數**的作法
- **隨機森林Random Forest**示範此圖下半部**需要調整參數**的作法
&lt;img src="https://cdn.jamanetwork.com/ama/content_public/journal/jama/938259/jug190001f2.png?Expires=2147483647&amp;Signature=cU6lP2ZYSdn9MyOakMWobXQF2h6LSPCExTP1q7x74zRH7gDgkRSqshXWADmcQUz0XJVK~aVPK3cb-~shWQ6vd6EF4FwIcR8NBXMlGq1sLDR5dXLwpb~qoEYzXvg03zCz2l0AHmdlFxy4IGYGG3ilBfuPh1SCweskxtaUfsWqGsUcwc6FNo3KjaR9j58eJeZOnBEr6a2OF2m~XlEOnT1W3vaYn2-fuGZLAQR88XcUGWp1LYgc6GnDTO1s7zj5m9mYhlL-CeOaLXQNGrSl6fAvw6LisZW-f2tChvIaDfCd4vuuNw-Q1V6sjm-jgUehMt8wjrc61YW6WqyIC9mF6VGzzg__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA" height="400px" style="display: block; margin: auto;" /&gt;
---
## 訓練組、測試組資料分割

- 不管要不要調參數，都需要分割**訓練組**與**測試組**
- 用`initial_split()`函數將資料分成訓練組與測試組
  - 第一個參數放資料`PimaIndiansDiabetes2`
  - 第二個參數`prop`放訓練組測試組比例`(3/4)`
  - 第三個參數`strata`放分組抽樣依據`diabetes`，針對此分組個別抽某個比例的人當訓練組，剩下的就當測試組。


```r
set.seed(123)
*splits&lt;- initial_split(PimaIndiansDiabetes2,
*                      prop=(3/4),
*                      strata = diabetes)
DM_train&lt;- training(splits)
DM_test&lt;- testing(splits)
```

---
## 訓練組、測試組資料分割

- 不管要不要調參數，都需要分割訓練組與測試組
- 用`initial_split()`函數將資料分成訓練組與測試組
  - 第一個參數放資料
  - 第二個參數`prop`放訓練組測試組比例
  - 第三個參數`strata`放分組抽樣依據，針對此分組個別抽某個比例的人當訓練組，剩下的就當測試組。
- 切割完後，用`training()`和`testing()`函數將訓練組測試組正式分開。


```r
set.seed(123)
splits&lt;- initial_split(PimaIndiansDiabetes2, 
                       prop=(3/4),
                       strata = diabetes)
*DM_train&lt;- training(splits)
*DM_test&lt;- testing(splits)
```
---
## 訓練組、測試組資料分割

- `initial_split()`函數有隨機的概念
- 為了讓每次的實驗結果相同，要**在有隨機事件前設定seed** `set.seed()`
- seed為隨機的依據，讓隨機每次都一樣，確保實驗結果可重複


```r
*set.seed(123)
splits&lt;- initial_split(PimaIndiansDiabetes2, 
                       prop=(3/4),
                       strata = diabetes)
DM_train&lt;- training(splits)
DM_test&lt;- testing(splits)
```
---
## 查看分組結果

.pull-left[
分組完後，查看訓練組的生病比例

```r
DM_train %&gt;% 
  count(diabetes) %&gt;% 
  mutate(prop = n/sum(n))
```

```
## # A tibble: 2 x 3
##   diabetes     n  prop
##   &lt;fct&gt;    &lt;int&gt; &lt;dbl&gt;
## 1 neg        197 0.668
## 2 pos         98 0.332
```
]

--
.pull-right[
查看測試組的生病比例

```r
DM_test %&gt;% 
  count(diabetes) %&gt;% 
  mutate(prop = n/sum(n))
```

```
## # A tibble: 2 x 3
##   diabetes     n  prop
##   &lt;fct&gt;    &lt;int&gt; &lt;dbl&gt;
## 1 neg         65 0.670
## 2 pos         32 0.330
```
]

---
class: inverse, center, middle

# 開始建模 - 資料前處理

---
## 建立資料前處理“食譜”

- 資料前處理也是建立兩種模型都必須經歷的方法
- 前處理包括將類別變項轉為虛擬變項(dummy variables)，數值變項取log，數值變項正規化，以及日期資料處理等

--

- 首先使用`recipe()`函數，設定模型訓練公式`diabetes ~ .`以及訓練用資料`DM_train`
  - 注意這邊只能用**訓練組資料**，不能用全部的資料
  - 公式：用`~`前方的`diabetes`當outcome (想要預測的值)，`~`後方的`.`代表其他所有剩下的欄位都當成predictors (又稱variables 或是 features)



```r
gen_recipe &lt;- 
* recipe(diabetes ~ ., data = DM_train) %&gt;%
  step_dummy(all_nominal(), -all_outcomes()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_predictors())
summary(gen_recipe)
```

```
## # A tibble: 9 x 4
##   variable type    role      source  
##   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   
## 1 pregnant numeric predictor original
## 2 glucose  numeric predictor original
## 3 pressure numeric predictor original
## 4 triceps  numeric predictor original
## 5 insulin  numeric predictor original
## 6 mass     numeric predictor original
## 7 pedigree numeric predictor original
## 8 age      numeric predictor original
## 9 diabetes nominal outcome   original
```

---
## 建立資料前處理“食譜”

完成模型公式與資料設定後，就開始逐一加上想要做的資料前處理方法


- `step_dummy(all_nominal(), -all_outcomes())` 將所有的類別變項轉成虛擬變項，除了Outcome以外
- `step_zv(all_predictors())` 若有變項都是一樣的值，刪掉。舉例來說，若是整個資料都是女性，那性別欄位就不用拿來當作features了
- `step_normalize(all_predictors())` 將所有數值變項正規化


```r
gen_recipe &lt;- 
  recipe(diabetes ~ ., data = DM_train) %&gt;% 
* step_dummy(all_nominal(), -all_outcomes()) %&gt;%
* step_zv(all_predictors()) %&gt;%
* step_normalize(all_predictors())
summary(gen_recipe)
```

```
## # A tibble: 9 x 4
##   variable type    role      source  
##   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   
## 1 pregnant numeric predictor original
## 2 glucose  numeric predictor original
## 3 pressure numeric predictor original
## 4 triceps  numeric predictor original
## 5 insulin  numeric predictor original
## 6 mass     numeric predictor original
## 7 pedigree numeric predictor original
## 8 age      numeric predictor original
## 9 diabetes nominal outcome   original
```

---
## 建立資料前處理“食譜”
還有很多其他的前處理方法：
- `step_naomit(everything(), skip = TRUE)` 如果沒有在一開始將NA資料刪掉，通常要去除NA值
- `step_rose(diabetes)` 設定oversampleing或是undersampling，範例用ROSE作為oversampling的演算法
- 參考`recipe()`函數的[說明文件](https://recipes.tidymodels.org/reference/recipe.html)


```r
gen_recipe &lt;- 
  recipe(diabetes ~ ., data = DM_train) %&gt;% 
  step_dummy(all_nominal(), -all_outcomes()) %&gt;%  
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_predictors())
*summary(gen_recipe)
```

```
## # A tibble: 9 x 4
##   variable type    role      source  
##   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   
## 1 pregnant numeric predictor original
## 2 glucose  numeric predictor original
## 3 pressure numeric predictor original
## 4 triceps  numeric predictor original
## 5 insulin  numeric predictor original
## 6 mass     numeric predictor original
## 7 pedigree numeric predictor original
## 8 age      numeric predictor original
## 9 diabetes nominal outcome   original
```
---
class: inverse, center, middle

# 邏輯迴歸Logistic Regression模型建立與效能評估範例

---
## Step 1 設定用邏輯迴建立模型

- 以邏輯迴歸為例
- 用`logistic_reg()`函數指定使用邏輯迴歸
- 用`set_engine("glm")`設定模型建立演算法


```r
lr_mod &lt;- 
* logistic_reg() %&gt;%
* set_engine("glm")
```
---
## Step 2 設定建模流程workflow

將建模 (model，從step 1來的)與資料前處理方法 (recipe，從前處理來的)串成單一工作流程workflow


```r
lr_wflow &lt;- 
* workflow() %&gt;%
* add_model(lr_mod) %&gt;%
* add_recipe(gen_recipe)
lr_wflow
```

```
## ══ Workflow ═══════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: logistic_reg()
## 
## ── Preprocessor ───────────────────────────────────────────────────────────────
## 3 Recipe Steps
## 
## ● step_dummy()
## ● step_zv()
## ● step_normalize()
## 
## ── Model ──────────────────────────────────────────────────────────────────────
## Logistic Regression Model Specification (classification)
## 
## Computational engine: glm
```

---
## Step 3 訓練模型

- 使用剛剛串起來的工作流程，加上`fit()`函數，完成建模


```r
lr_fit &lt;- 
  lr_wflow %&gt;% 
* fit(data=DM_train)
```

---
## Step 3 訓練模型

- 使用剛剛串起來的工作流程，加上`fit()`函數，完成建模

```r
lr_fit &lt;- 
  lr_wflow %&gt;% 
  fit(data=DM_train) 
```

- 用`pull_workflow_fit()`與`tidy()`呈現建模結果，注意這裡也是只能用**訓練組資料**`DM_train`


```r
lr_fit %&gt;% 
* pull_workflow_fit() %&gt;%
* tidy()
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; term &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; estimate &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; std.error &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; statistic &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; p.value &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; (Intercept) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.9399004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1575646 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -5.9651752 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0000000 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pregnant &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2232861 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1971191 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.1327476 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2573203 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; glucose &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.0707970 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1950975 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5.4885222 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0000000 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pressure &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.1158912 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1619846 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.7154459 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.4743336 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; triceps &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.0126884 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2015624 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.0629500 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.9498063 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; insulin &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.0925636 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1746867 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.5298836 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.5961927 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
## Step 4 使用模型與測試組資料驗證模型效能

- 剛剛訓練出來的模型`lr_fit`丟入`predict()`函數，指定以一開始分出的測試組`DM_test`產生預測結果
- 注意這邊**只能用測試組資料**`DM_test`


```r
lr_pred &lt;- lr_fit %&gt;% 
* predict(DM_test)
```

```r
lr_pred
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .pred_class &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 4 使用模型與測試組資料驗證模型效能
- 通常會直接將`predict()`函數預測結果與真實答案結合
- 答案為**測試組資料**`DM_test`中的diabetes欄位
- 將預測結果丟入`bind_cols()`，並指定與答案直接結合


```r
lr_pred &lt;- lr_fit %&gt;%
  predict(DM_test) %&gt;% 
* bind_cols(DM_test %&gt;% select(diabetes))
```

```r
lr_pred
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .pred_class &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; diabetes &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 4 使用模型與測試組資料驗證模型效能
使用`accuracy()`函數，輸入剛剛整合的**預測結果**與**真實答案**計算正確率


```r
lr_pred %&gt;% 
* accuracy(truth = diabetes,
*         .pred_class)
```

```
## # A tibble: 1 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.814
```

---
## Step 4 使用模型與測試組資料驗證模型效能

- 很多時候我們需要回報**Area under the ROC curve**
- 此時不能直接採用模型預測pos或neg的結果
- 需要的連續性的預測數值來畫**ROC curve**
- 將`predict()`函數的`type`參數設定為prob，即回傳各組預測值


```r
lr_pred &lt;- lr_fit %&gt;%
  predict(DM_test,
*         type = "prob")%&gt;%
  bind_cols(DM_test %&gt;% select(diabetes)) 
```

```r
lr_pred
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; .pred_neg &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; .pred_pos &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; diabetes &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.1802343 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8197657 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.6479680 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.3520320 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.8500444 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1499556 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.0682963 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.9317037 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.1247665 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8752335 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.1262743 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8737257 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 4 使用模型與測試組資料驗證效能
將預測結果`lr_pred`丟入`roc_curve()`，加上`autoplot()`畫ROC curve

```r
lr_pred %&gt;% 
* roc_curve(truth = diabetes,
*           .pred_pos) %&gt;%
* autoplot()
```

&lt;img src="DataMining_files/figure-html/unnamed-chunk-57-1.png" height="350px" style="display: block; margin: auto;" /&gt;

---
## Step 4 使用模型與測試組資料驗證效能
當然也能用`roc_auc()`算Area under the ROC curve


```r
lr_pred %&gt;% 
* roc_auc(truth = diabetes,
*         .pred_pos)
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .metric &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .estimator &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; .estimate &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.9206731 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 5 解釋模型
- 以迴歸為例，參數即可解釋各變數與模型的關係
- 用`pull_workflow_fit()`與`tidy()`呈現建模結果


```r
lr_fit %&gt;% 
* pull_workflow_fit() %&gt;%
* tidy()
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; term &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; estimate &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; std.error &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; statistic &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; p.value &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; (Intercept) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.9399004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1575646 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -5.9651752 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0000000 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pregnant &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2232861 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1971191 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.1327476 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2573203 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; glucose &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.0707970 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1950975 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5.4885222 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0000000 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pressure &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.1158912 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1619846 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.7154459 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.4743336 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; triceps &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.0126884 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2015624 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.0629500 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.9498063 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; insulin &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.0925636 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1746867 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -0.5298836 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.5961927 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; mass &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.4998571 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2111084 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.3677750 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0178954 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pedigree &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.3092734 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1663840 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.8587933 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0630564 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; age &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.3915963 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2083075 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.8798951 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0601224 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
# 完成
以上就是使用**邏輯迴歸**建立模型與效能測試流程，可以發現完全沒有調整任何參數，因基本邏輯迴歸不用調參數。

---
class: inverse, center, middle

# 隨機森林Random Forest模型建立、參數調整與效能評估範例
---
## Step 1 設定平行處理

因為模型參數調整需要一直不斷建立模型與測試，所以設定平行處理會快一些，`tidymodels`套組支援平行處理，細節可參考[官方文件](https://tune.tidymodels.org/articles/extras/optimizations.html)


```r
library(parallel)
library(doParallel)
all_cores &lt;- detectCores(logical = FALSE)
cl &lt;- makePSOCKcluster(all_cores)
registerDoParallel(cl)
```

---
## Step 2 設定用隨機森林建立模型以及要調整的參數

- 用`rand_forest()`函數指定要建立隨機森林模型
- 用`set_engine("ranger")`設定模型建立演算法為基於`ranger`套件的隨機森林演算法，沒裝過`ranger`套件的話需要先裝
  - "permutation": Consider a variable important if it has a positive effect on the prediction performance. (Mean decrease accuracy)
  - "impurity": Gini index for classification 
- 因為隨機森林有迴歸版與分類版，因此使用`set_mode("classification")`設定我們要用分類演算法


```r
install.packages("ranger")
```


```r
rf_mod &lt;- 
  rand_forest(mtry = tune(), min_n = tune(), 
              trees = 1000) %&gt;% 
  set_engine("ranger",
             importance= "permutation") %&gt;% 
  set_mode("classification")
```

---
## Step 2 設定用隨機森林建立模型以及要調整的參數

在隨機森林`rand_forest()`函數中，可設定幾個參數，說明如下:

- mtry: 在切割節點時，隨機抽取n個特徵，並從中選最適合的特徵當作節點
- min_n: 每個節點的最小資料數，如果設為10，當該節點的資料剩十筆或更少時，就不會再切割
- trees: 建模要用幾棵樹

-- 

在這個範例中，我將要建幾棵樹設定為1000，其他兩個參數則是想用資料調整，因此將想調的參數值設為`tune()`，表示這些參數要調，不想在現階段指定。


```r
rf_mod &lt;- 
* rand_forest(mtry = tune(), min_n = tune(),
*             trees = 1000) %&gt;%
  set_engine("ranger",
             importance= "permutation") %&gt;% 
  set_mode("classification")
```
---
## Step 2 設定用隨機森林建立模型以及要調整的參數
模型設定完成後，輸出如下

```r
rf_mod
```

```
## Random Forest Model Specification (classification)
## 
## Main Arguments:
##   mtry = tune()
##   trees = 1000
##   min_n = tune()
## 
## Engine-Specific Arguments:
##   importance = permutation
## 
## Computational engine: ranger
```

---
## Step 3 設定建模流程workflow

建模流程同邏輯迴歸，將模型 (model，從step 2來的)與資料前處理方法(recipe，從前處理來的)串接成一個工作流程


```r
rf_wflow &lt;- workflow() %&gt;%
* add_model(rf_mod) %&gt;%
* add_recipe(gen_recipe)
rf_wflow
```

```
## ══ Workflow ═══════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ───────────────────────────────────────────────────────────────
## 3 Recipe Steps
## 
## ● step_dummy()
## ● step_zv()
## ● step_normalize()
## 
## ── Model ──────────────────────────────────────────────────────────────────────
## Random Forest Model Specification (classification)
## 
## Main Arguments:
##   mtry = tune()
##   trees = 1000
##   min_n = tune()
## 
## Engine-Specific Arguments:
##   importance = permutation
## 
## Computational engine: ranger
```

---
## Step 4 參數調整組資料分割

- 剛剛有提到要以資料調整的參數**mtry**以及**min_n**
- 首先將所有資料分成測試組訓練組，也就是本篇文章一開始做的切割
- 為了調整參數，再切訓練組資料，分成的**調整訓練**組以及**調整測試**組。
&lt;img src="https://www.tidymodels.org/start/resampling/img/resampling.svg" height="350px" style="display: block; margin: auto;" /&gt;
[圖片來源](https://www.tidymodels.org/start/resampling/)



---
## Step 4 參數調整組資料分割
- 切割**參數調整組**有很多種方法，可以用**bootstrap**法隨機抽，也可使用這邊的**交叉驗證**(Cross Validation)範例
- 圖片下半部為5-fold CV 的示意圖
- 每份資料都會被拿來當作**調整訓練**以及**調整測試**組
- 經過幾次測試後，用**調整測試**組的效能來決定一組最佳參數

&lt;img src="https://www.frontiersin.org/files/Articles/411217/fmicb-09-02393-HTML/image_m/fmicb-09-02393-g002.jpg" height="350px" style="display: block; margin: auto;" /&gt;
[圖片來源](https://doi.org/10.3389/fmicb.2018.02393)


---
## Step 4 參數調整組資料分割
- 使用10-fold CV 為例，先用`vfold_cv()`函數
  - 設定分割基準為**訓練組**`DM_train`
  - 要分10份`v=10`
  - 分割時要注意糖尿病的比例不能差太多，因此設為分組依據 `strata = diabetes`


```r
set.seed(345)
*folds &lt;- vfold_cv(DM_train,
*                 v = 10,
*                 strata = diabetes)
folds
```

```
## #  10-fold cross-validation using stratification 
## # A tibble: 10 x 2
##    splits           id    
##    &lt;named list&gt;     &lt;chr&gt; 
##  1 &lt;split [265/30]&gt; Fold01
##  2 &lt;split [265/30]&gt; Fold02
##  3 &lt;split [265/30]&gt; Fold03
##  4 &lt;split [265/30]&gt; Fold04
##  5 &lt;split [265/30]&gt; Fold05
##  6 &lt;split [265/30]&gt; Fold06
##  7 &lt;split [265/30]&gt; Fold07
##  8 &lt;split [266/29]&gt; Fold08
##  9 &lt;split [267/28]&gt; Fold09
## 10 &lt;split [267/28]&gt; Fold10
```
---
## Step 5 調整參數

- 將Step 3所建立的建模流程`rf_wflow`串接至`tune_grid()`函數，設定參數調整的方法
  - 設定切割好的**參數調整組**  `resamples = folds`
  - 要測試幾組參數   `grid = 50`
  - 測試時要用什麼效能評估方式，設定為Area under the ROC curve `metrics = metric_set(roc_auc)`
- 因為要重複訓練測試多次，因此這程式碼執行會需要一些時間。


```r
rf_res &lt;- 
  rf_wflow %&gt;% 
  tune_grid(
*   resamples = folds,
*   grid = 50,
*   metrics = metric_set(roc_auc),
    control=control_resamples(save_pred = TRUE)
    )
```

---
## Step 5 調整參數
執行完後，可用`collect_metrics()`查看各參數效能

```r
rf_res %&gt;%
* collect_metrics()
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; mtry &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; min_n &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .metric &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .estimator &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; mean &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; n &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; std_err &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8017105 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0240486 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 15 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8095088 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0246020 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 27 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8059503 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0246762 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8025409 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0241123 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 21 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8102953 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0224259 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 23 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8092105 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0233824 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 5 調整參數
也可畫個圖呈現參數調整對效能的影響，由圖可知在這個範例中min_n越大效能越好


```r
rf_res %&gt;%
  collect_metrics() %&gt;%
  mutate(mtry=factor(mtry)) %&gt;%
  ggplot(aes(min_n, mean, color = mtry)) + 
  geom_line(size=1)
```

&lt;img src="DataMining_files/figure-html/unnamed-chunk-74-1.png" height="350px" style="display: block; margin: auto;" /&gt;
---
## Step 5 調整參數
搭配`show_best()`函數可呈現Area under the ROC curve最優的幾組參數


```r
rf_res %&gt;%
* show_best("roc_auc")
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; mtry &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; min_n &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .metric &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .estimator &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; mean &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; n &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; std_err &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 30 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8164415 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0211091 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 31 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8164327 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0225916 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 33 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8136023 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0216921 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 25 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8129415 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0210267 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 38 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8126287 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.0230154 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
## Step 6 使用最佳參數與訓練組資料建立最終模型

- 使用最佳參數(意即Area under the ROC curve最高的一組參數)來建立最終模型
- 將剛剛調參數的結果`rf_res`輸入`select_best()`函數，選出最好的一組參數`best_rf`


```r
best_rf &lt;- rf_res %&gt;%
* select_best("roc_auc")
```

```r
best_rf
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; mtry &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; min_n &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 30 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 6 使用最佳參數與訓練組資料建立最終模型
將Step 3 建立的工作流程輸入`finalize_workflow()`函數，並指定要用剛剛選出的最佳參數`best_rf`，建立一個**最終建模流程**


```r
final_wflow &lt;- 
  rf_wflow %&gt;% 
* finalize_workflow(best_rf)

final_wflow
```

```
## ══ Workflow ═══════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ───────────────────────────────────────────────────────────────
## 3 Recipe Steps
## 
## ● step_dummy()
## ● step_zv()
## ● step_normalize()
## 
## ── Model ──────────────────────────────────────────────────────────────────────
## Random Forest Model Specification (classification)
## 
## Main Arguments:
##   mtry = 3
##   trees = 1000
##   min_n = 30
## 
## Engine-Specific Arguments:
##   importance = permutation
## 
## Computational engine: ranger
```
---
## Step 6 使用最佳參數與訓練組資料建立最終模型
**最終建模流程** `final_wflow`建立後，即可用`fit()`建模，注意這邊用的是完整的訓練資料`DM_train`


```r
final_rf_model &lt;- 
  final_wflow %&gt;%
* fit(data = DM_train)

final_rf_model
```

```
## ══ Workflow [trained] ═════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ───────────────────────────────────────────────────────────────
## 3 Recipe Steps
## 
## ● step_dummy()
## ● step_zv()
## ● step_normalize()
## 
## ── Model ──────────────────────────────────────────────────────────────────────
## Ranger result
## 
## Call:
##  ranger::ranger(formula = formula, data = data, mtry = ~3L, num.trees = ~1000,      min.node.size = ~30L, importance = ~"permutation", num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1), probability = TRUE) 
## 
## Type:                             Probability estimation 
## Number of trees:                  1000 
## Sample size:                      295 
## Number of independent variables:  8 
## Mtry:                             3 
## Target node size:                 30 
## Variable importance mode:         permutation 
## Splitrule:                        gini 
## OOB prediction error (Brier s.):  0.1572738
```

---
## Step 7 用測試組資料驗證最終效能

- 將剛剛訓練出來的模型`final_rf_model`輸入`predict()`函數
- 並指定使用一開始分出的測試組`DM_test`產生預測結果
- 注意要用**測試組資料**


```r
rf_pred &lt;- final_rf_model %&gt;% 
* predict(DM_test)
```

```r
rf_pred
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .pred_class &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
## Step 7 用測試組資料驗證最終效能

- 通常會直接將`predict()`函數預測結果與真實答案結合
- 答案為**測試組資料**`DM_test`中的diabetes欄位
- 將預測結果丟入`bind_cols()`，並指定與答案直接結合

```r
rf_pred &lt;- final_rf_model %&gt;%
  predict(DM_test) %&gt;% 
* bind_cols(DM_test %&gt;% select(diabetes))
```

```r
rf_pred
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .pred_class &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; diabetes &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 7 用測試組資料驗證最終效能
使用預測結果與真實答案計算正確率

```r
rf_pred %&gt;% 
* accuracy(truth = diabetes,
*         .pred_class)
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .metric &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .estimator &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; .estimate &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; accuracy &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8041237 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 7 用測試組資料驗證最終效能
- 很多時候我們需要回報**Area under the ROC curve**
- 此時不能直接採用模型預測pos或neg的結果
- 需要的連續性的預測數值來畫**ROC curve**
- 將`predict()`函數的`type`參數設定為prob，即回傳各組預測值


```r
rf_pred &lt;- final_rf_model %&gt;%
  predict(DM_test,
*         type = "prob")%&gt;%
  bind_cols(DM_test %&gt;% select(diabetes)) 
```

```r
rf_pred
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; .pred_neg &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; .pred_pos &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; diabetes &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.3573604 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.6426396 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.5301730 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.4698270 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.6717796 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.3282204 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; neg &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.1584287 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8415713 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.1206967 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8793033 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.1809000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.8191000 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; pos &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
## Step 7 用測試組資料驗證最終效能
將預測結果`lr_pred`丟入`roc_curve()`，加上`autoplot()`畫ROC curve

```r
rf_pred %&gt;% 
* roc_curve(truth = diabetes,
*           .pred_pos) %&gt;%
* autoplot()
```

&lt;img src="DataMining_files/figure-html/unnamed-chunk-93-1.png" height="350px" style="display: block; margin: auto;" /&gt;
---
## Step 7 用測試組資料驗證最終效能
當然也能用`roc_auc()`算Area under the ROC curve

```r
rf_pred %&gt;% 
* roc_auc(truth = diabetes,
*         .pred_pos)
```
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; .metric &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; .estimator &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; .estimate &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; roc_auc &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; binary &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.9139423 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
## Step 8 解釋模型
- 查看最終模型`final_rf_model`中，各變數的重要性
- 用`pull_workflow_fit()`將模型資訊取出
- 丟入`vip()`查看各變數重要性

```r
library(vip)
final_rf_model %&gt;%
  pull_workflow_fit() %&gt;%
  vi()
```

```
## # A tibble: 8 x 2
##   Variable Importance
##   &lt;chr&gt;         &lt;dbl&gt;
## 1 glucose    0.0452  
## 2 age        0.0210  
## 3 insulin    0.0196  
## 4 mass       0.00865 
## 5 pregnant   0.00522 
## 6 triceps    0.00281 
## 7 pedigree   0.00200 
## 8 pressure  -0.000999
```
---
## Step 8 解釋模型
- 查看最終模型`final_rf_model`中，各變數的重要性
- 用`pull_workflow_fit()`將模型資訊取出
- 丟入`vip()`查看各變數重要性

```r
library(vip)
final_rf_model %&gt;%
  pull_workflow_fit() %&gt;%
  vip()
```

&lt;img src="DataMining_files/figure-html/unnamed-chunk-97-1.png" height="350px" style="display: block; margin: auto;" /&gt;
---
# 完成
以上就是使用**隨機森林**建立模型、調整參數以及與效能測試流程，多了使用交叉驗證法調整參數的步驟。



---
class: inverse, center, middle

# 正紅的XGBoost模型建立、參數調整與效能評估範例
---
## XGBoost不分步驟，一次搞定 (1/3)


```r
#install.packages("xgboost")
xgb_mod &lt;- 
* boost_tree(mtry = tune(),
*            min_n = tune(),
*             trees = 1000) %&gt;%
* set_engine("xgboost",
*            importance= "permutation") %&gt;%
  set_mode("classification")
xgb_wflow &lt;- workflow() %&gt;%
  add_model(xgb_mod) %&gt;%  
  add_recipe(gen_recipe) 
xgb_res &lt;- 
  xgb_wflow %&gt;% 
  tune_grid(
    resamples = folds,
    grid = 50,
    metrics = metric_set(roc_auc),
    control=control_resamples(save_pred = TRUE)
    )
```

```
## i Creating pre-processing data to finalize unknown parameter: mtry
```
---
## XGBoost不分步驟，一次搞定 (2/3)


```r
best_xgb &lt;- xgb_res %&gt;%
  select_best("roc_auc")
final_wflow &lt;- 
  xgb_wflow %&gt;% 
  finalize_workflow(best_xgb)
final_xgb_model &lt;- 
  final_wflow %&gt;%
  fit(data = DM_train) 
xgb_pred &lt;- final_xgb_model %&gt;%
  predict(DM_test,
          type = "prob")%&gt;% 
  bind_cols(DM_test %&gt;% select(diabetes)) 
```
---
## XGBoost不分步驟，一次搞定 (3/3)


```r
xgb_pred %&gt;% 
  roc_curve(truth = diabetes, 
            .pred_pos) %&gt;% 
  autoplot()
```

&lt;img src="DataMining_files/figure-html/unnamed-chunk-100-1.png" height="400px" style="display: block; margin: auto;" /&gt;
---
class: inverse, center, middle
# 上課教的SVM模型建立、參數調整與效能評估範例
---
## SVM不分步驟，一次搞定 (1/3)


```r
#install.packages("kernlab")
svm_mod &lt;- 
* svm_rbf(cost=tune(),
*         rbf_sigma=tune(),
*         margin=tune()) %&gt;%
* set_engine("kernlab",
*            importance= "permutation") %&gt;%
  set_mode("classification")
svm_wflow &lt;- workflow() %&gt;%
  add_model(svm_mod) %&gt;%  
  add_recipe(gen_recipe) 
svm_res &lt;- 
  svm_wflow %&gt;% 
  tune_grid(
    resamples = folds,
    grid = 50,
    metrics = metric_set(roc_auc),
    control=control_resamples(save_pred = TRUE)
    )
```
---
## SVM不分步驟，一次搞定 (2/3)


```r
best_svm &lt;- svm_res %&gt;%
  select_best("roc_auc")
final_wflow &lt;- 
  svm_wflow %&gt;% 
  finalize_workflow(best_svm)
final_svm_model &lt;- 
  final_wflow %&gt;%
  fit(data = DM_train) 
svm_pred &lt;- final_svm_model %&gt;%
  predict(DM_test,
          type = "prob")%&gt;% 
  bind_cols(DM_test %&gt;% select(diabetes)) 
```

---
## SVM不分步驟，一次搞定 (3/3)


```r
svm_pred %&gt;% 
  roc_curve(truth = diabetes, 
            .pred_pos) %&gt;% 
  autoplot()
```

&lt;img src="DataMining_files/figure-html/unnamed-chunk-103-1.png" height="400px" style="display: block; margin: auto;" /&gt;

---
# tidymodels總結

- [官方說明文件](https://www.tidymodels.org/)完整
- 建模、調參數、預測流程架構清楚
- 目前支援21大類模型，可透過[模型清單](https://www.tidymodels.org/find/parsnip/)查找，自行替換模型
- 不知道每個模型有何參數可調？一樣可透過[參數清單](https://www.tidymodels.org/find/parsnip/#model-args)查找
- 不知道參數意義？了解各模型的原理還是很重要的！
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
